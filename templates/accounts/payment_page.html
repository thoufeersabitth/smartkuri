{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment - SmartKuri</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'accounts/css/payment_page.css' %}">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'accounts/images/favicon.ico' %}" type="image/x-icon">
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-overlay">
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-3">Processing your payment...</p>
        </div>
    </div>

    <div class="payment-wrapper">

    <!-- Header Section -->
<header class="payment-header">
    <div class="logo-container">
        <i class="bi bi-shield-check logo-icon"></i>
        <span class="logo-text">SmartKuri</span>
    </div>

    <div class="security-badge">
        <i class="bi bi-lock-fill"></i>
        <span>Secure Payment</span>
    </div>
</header>

<main class="payment-content">

    <!-- Subscription Summary Card -->
    <div class="order-summary-card">
        <div class="card-header">
            <h2>
                <i class="bi bi-box-seam me-2"></i>
                Subscription Summary
            </h2>
        </div>

        <div class="card-body">

            <!-- Group Details -->
            <div class="group-details mb-4">
                <h3 class="group-name">{{ data.group_name }}</h3>
                <p class="group-description">
                    Subscription details for your selected plan
                </p>
            </div>

            <!-- Plan Details -->
            <div class="plan-details">

                <div class="detail-row">
                    <span class="detail-label">Subscription Plan</span>
                    <span class="detail-value">
                        {{ data.plan_name|default:"Premium Plan" }}
                    </span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Subscription Period</span>
                    <span class="detail-value">
                        {{ data.duration_display }}
                    </span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Maximum Members Allowed</span>
                    <span class="detail-value">
                        {{ data.max_members|default:100 }} Members
                    </span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Included Features</span>
                    <span class="detail-value">
                        <span class="feature-tag">Dashboard</span>
                        <span class="feature-tag">Analytics</span>
                        <span class="feature-tag">Support</span>
                    </span>
                </div>

            </div>

            <hr class="my-4">

            <!-- Amount -->
            <div class="total-amount">
                <div class="amount-display">
                    <span class="amount-label">Subscription Amount</span>
                    <span class="amount-value">
                        ₹{{ data.plan_price }}
                    </span>
                </div>
                <small class="text-muted d-block mt-2">
                    (Inclusive of all taxes)
                </small>
            </div>

        </div>
    </div>

    <!-- Payment Method Card -->
    <div class="payment-methods-card">
        <div class="card-header">
            <h2>
                <i class="bi bi-credit-card me-2"></i>
                Payment Method
            </h2>
        </div>

        <div class="card-body">

            <div class="selected-method">
                <div class="method-icon">
                    <i class="bi bi-bank"></i>
                </div>

                <div class="method-info">
                    <h4>Razorpay</h4>
                    <p>Secure payment gateway powered by Razorpay</p>
                </div>

                <div class="method-badge">
                    <span class="badge bg-success">Recommended</span>
                </div>
            </div>

            <button id="pay-button" class="pay-button">
                <i class="bi bi-lock-fill me-2"></i>
                <span class="button-text">
                    Pay ₹{{ data.plan_price }}
                </span>
                <i class="bi bi-arrow-right ms-2"></i>
            </button>

            <div class="security-assurance">
                <div class="security-item">
                    <i class="bi bi-shield-check text-success"></i>
                    <span>PCI DSS Compliant</span>
                </div>
                <div class="security-item">
                    <i class="bi bi-encryption text-success"></i>
                    <span>256-bit SSL Encryption</span>
                </div>
                <div class="security-item">
                    <i class="bi bi-safe text-success"></i>
                    <span>Secure &amp; Encrypted</span>
                </div>
            </div>

        </div>
    </div>

    <!-- Hidden Payment Form -->
    <form id="payment-form" method="POST" action="{% url 'accounts:payment_success' %}">
        {% csrf_token %}
        <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
        <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
        <input type="hidden" name="razorpay_signature" id="razorpay_signature">
        <input type="hidden" name="group_id" value="{{ data.group_id }}">
        <input type="hidden" name="user_id" value="{{ data.user_id }}">
    </form>

</main>

</div>



        <!-- Footer -->
        <footer class="payment-footer">
            <div class="footer-links">
                <a href="#" class="footer-link"><i class="bi bi-shield-lock"></i> Privacy Policy</a>
                <a href="#" class="footer-link"><i class="bi bi-file-text"></i> Terms of Service</a>
                <a href="#" class="footer-link"><i class="bi bi-question-circle"></i> Support</a>
            </div>
            <div class="copyright">
                <p>© 2024 SmartKuri. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Razorpay Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // payment.js
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const payButton = document.getElementById('pay-button');
            const paymentForm = document.getElementById('payment-form');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // Payment Configuration
            const paymentOptions = {
                key: "{{ razorpay_key_id }}",
                amount: "{{ amount }}",
                currency: "{{ currency }}",
                name: "SmartKuri",
                description: `Payment for group: {{ data.group_name }}`,
                order_id: "{{ razorpay_order_id }}",
                handler: handlePaymentSuccess,
                prefill: {
                    name: "{{ data.user_name|default:'Customer' }}",
                    email: "{{ data.user_email|default:'' }}",
                    contact: "{{ data.user_phone|default:'' }}"
                },
                theme: {
                    color: "#4361ee"
                },
                modal: {
                    ondismiss: handlePaymentClose,
                    escape: true,
                    animation: true
                },
                retry: {
                    enabled: true,
                    max_count: 3
                }
            };

            // Initialize Razorpay
            let rzp1 = null;

            // Payment Button Click Handler
            payButton.addEventListener('click', function(e) {
                e.preventDefault();
                startPayment();
            });

            // Start Payment Process
            function startPayment() {
                try {
                    // Show loading
                    showLoading();
                    
                    // Update button state
                    payButton.classList.add('processing');
                    payButton.innerHTML = `
                        <i class="bi bi-hourglass-split me-2"></i>
                        <span class="button-text">Processing...</span>
                    `;
                    
                    // Initialize Razorpay
                    rzp1 = new Razorpay(paymentOptions);
                    
                    // Event Listeners
                    rzp1.on('payment.failed', handlePaymentFailed);
                    rzp1.on('payment.captured', handlePaymentCaptured);
                    
                    // Open Razorpay
                    rzp1.open();
                    
                } catch (error) {
                    console.error('Payment initialization error:', error);
                    showError('Failed to initialize payment. Please try again.');
                    hideLoading();
                    resetButton();
                }
            }

            // Handle Payment Success
            function handlePaymentSuccess(response) {
                try {
                    console.log('Payment successful:', response);
                    
                    // Update form with response
                    document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
                    document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
                    document.getElementById('razorpay_signature').value = response.razorpay_signature;
                    
                    // Add animation to button
                    payButton.classList.remove('processing');
                    payButton.classList.add('success');
                    payButton.innerHTML = `
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <span class="button-text">Payment Successful!</span>
                    `;
                    
                    // Show success message
                    showSuccessMessage('Payment verified! Redirecting...');
                    
                    // Submit form after delay
                    setTimeout(() => {
                        paymentForm.submit();
                    }, 1500);
                    
                } catch (error) {
                    console.error('Payment success handler error:', error);
                    showError('Payment verification failed. Please contact support.');
                }
            }

            // Handle Payment Failure
            function handlePaymentFailed(response) {
                console.error('Payment failed:', response.error);
                
                // Extract error message
                let errorMessage = 'Payment failed. Please try again.';
                if (response.error && response.error.description) {
                    errorMessage = response.error.description;
                }
                
                // Show error
                showError(errorMessage);
                
                // Reset button
                setTimeout(() => {
                    resetButton();
                }, 2000);
            }

            // Handle Payment Captured
            function handlePaymentCaptured(response) {
                console.log('Payment captured:', response);
            }

            // Handle Modal Close
            function handlePaymentClose() {
                console.log('Payment modal closed by user');
                hideLoading();
                resetButton();
            }

            // Show Loading
            function showLoading() {
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'flex';
                    loadingSpinner.style.animation = 'fadeIn 0.3s ease-out';
                }
            }

            // Hide Loading
            function hideLoading() {
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
            }

            // Reset Button State
            function resetButton() {
                payButton.classList.remove('processing', 'success', 'error');
                payButton.innerHTML = `
                    <i class="bi bi-lock-fill me-2"></i>
                    <span class="button-text">Pay ₹{{ data.plan_price }}</span>
                    <i class="bi bi-arrow-right ms-2"></i>
                `;
            }

            // Show Success Message
            function showSuccessMessage(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success alert-dismissible fade show';
                successDiv.innerHTML = `
                    <i class="bi bi-check-circle-fill me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert before payment form
                paymentForm.parentNode.insertBefore(successDiv, paymentForm);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    successDiv.remove();
                }, 5000);
            }

            // Show Error Message
            function showError(message) {
                // Remove existing errors
                const existingErrors = document.querySelectorAll('.error-message');
                existingErrors.forEach(error => error.remove());
                
                // Create error element
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message alert alert-danger alert-dismissible fade show';
                errorDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert before payment button
                payButton.parentNode.insertBefore(errorDiv, payButton);
                
                // Add error class to button
                payButton.classList.add('error');
                
                // Update button text
                payButton.innerHTML = `
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span class="button-text">Try Again</span>
                `;
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    errorDiv.remove();
                    payButton.classList.remove('error');
                }, 5000);
            }

            // Keyboard Shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + Enter to initiate payment
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    startPayment();
                }
                
                // Escape to close payment modal
                if (e.key === 'Escape' && rzp1) {
                    rzp1.close();
                }
            });

            // Prevent Form Resubmission
            if (window.history.replaceState) {
                window.history.replaceState(null, null, window.location.href);
            }

            // Add page load animation
            document.querySelector('.payment-wrapper').style.animation = 'fadeIn 0.5s ease-out';
            
            // Initialize tooltips if Bootstrap is loaded
            if (typeof bootstrap !== 'undefined') {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        });

        // Network status monitoring
        window.addEventListener('online', function() {
            console.log('Network connection restored');
            // You could add a notification here
        });

        window.addEventListener('offline', function() {
            console.log('Network connection lost');
            showError('Network connection lost. Please check your internet connection.');
        });
    </script>
</body>
</html>